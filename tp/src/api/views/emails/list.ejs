<%
let content = `
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <div>
        <h1><i class="bi bi-envelope"></i> Company Emails</h1>
        <p class="text-muted">Manage extracted company emails</p>
      </div>
      <div class="btn-group">
        <a href="/emails/new" class="btn btn-primary">
          <i class="bi bi-plus-lg"></i> Add Email
        </a>
        <a href="/emails/export${filters.campaign ? '?campaign=' + filters.campaign : ''}${filters.domain_match ? (filters.campaign ? '&' : '?') + 'domain_match=' + filters.domain_match : ''}${filters.generic ? (filters.campaign || filters.domain_match ? '&' : '?') + 'generic=' + filters.generic : ''}${filters.search ? (filters.campaign || filters.domain_match || filters.generic ? '&' : '?') + 'search=' + encodeURIComponent(filters.search) : ''}" class="btn btn-success">
          <i class="bi bi-file-earmark-spreadsheet"></i> Export Emails
        </a>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleFilters()">
          <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h6>
          <i class="bi bi-chevron-down" id="filterToggleIcon"></i>
        </div>
        <div class="card-body" id="filtersBody">
          <form method="GET" action="/emails">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label small fw-semibold"><i class="bi bi-megaphone me-1"></i>Campaign</label>
                <select name="campaign" class="form-select form-select-sm">
                  <option value="">All Campaigns</option>
${campaigns.map(c => `
                  <option value="${c.id}" ${filters.campaign == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small fw-semibold"><i class="bi bi-link-45deg me-1"></i>Domain Match</label>
                <select name="domain_match" class="form-select form-select-sm">
                  <option value="">All Domain Matches</option>
                  <option value="true" ${filters.domain_match === 'true' ? 'selected' : ''}>Match</option>
                  <option value="false" ${filters.domain_match === 'false' ? 'selected' : ''}>No Match</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small fw-semibold"><i class="bi bi-tag me-1"></i>Email Type</label>
                <select name="generic" class="form-select form-select-sm">
                  <option value="">All Types</option>
                  <option value="true" ${filters.generic === 'true' ? 'selected' : ''}>Generic</option>
                  <option value="false" ${filters.generic === 'false' ? 'selected' : ''}>Specific</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small fw-semibold"><i class="bi bi-search me-1"></i>Search</label>
                <input type="text" name="search" class="form-control form-control-sm" placeholder="Search email..." value="${filters.search || ''}">
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12 d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-check-circle"></i> Apply Filters</button>
                <a href="/emails" class="btn btn-outline-secondary btn-sm"><i class="bi bi-x-circle"></i> Clear All</a>
                <a href="/blog-emails" class="btn btn-outline-info btn-sm"><i class="bi bi-journal-text"></i> View Blog Emails</a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Emails Table -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-sm">
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Domain</th>
                  <th>Company</th>
                  <th>Domain Match</th>
                  <th>Generic</th>
                  <th>Confidence</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
${emails.map(email => `
                <tr>
                  <td><a href="mailto:${email.email}">${email.email}</a></td>
                  <td><a href="/prospects/${email.prospect_id}">${email.domain}</a></td>
                  <td>${email.company_name || '-'}</td>
                  <td>
                    <span class="badge bg-${email.is_domain_match ? 'success' : 'secondary'}">
                      ${email.is_domain_match ? 'Yes' : 'No'}
                    </span>
                  </td>
                  <td>
                    <span class="badge bg-${email.is_generic ? 'warning text-dark' : 'info'}">
                      ${email.is_generic ? 'Yes' : 'No'}
                    </span>
                  </td>
                  <td>${email.confidence}%</td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <a href="/emails/${email.id}" class="btn btn-outline-primary" title="View">
                        <i class="bi bi-eye"></i>
                      </a>
                      <a href="/emails/${email.id}/edit" class="btn btn-outline-secondary" title="Edit">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <form method="POST" action="/emails/${email.id}/delete" class="d-inline">
                        <button type="submit" class="btn btn-outline-danger" title="Delete" onclick="return confirm('Delete this email?');">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>`).join('')}

${emails.length === 0 ? `
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">No emails found.</td>
                </tr>` : ''}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function toggleFilters() {
  const body = document.getElementById('filtersBody');
  const icon = document.getElementById('filterToggleIcon');
  if (body.style.display === 'none') {
    body.style.display = 'block';
    icon.classList.remove('bi-chevron-down');
    icon.classList.add('bi-chevron-up');
  } else {
    body.style.display = 'none';
    icon.classList.remove('bi-chevron-up');
    icon.classList.add('bi-chevron-down');
  }
}
</script>
`;
%>
<%- include('../layout', { title: 'Emails - Outreach Admin', activePage: 'emails', content: content, user: user }) %>
