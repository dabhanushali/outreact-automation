<%
// Get auto_schedule setting
const autoScheduleSetting = settings.find(s => s.key === 'auto_schedule_followups');
const autoSchedule = autoScheduleSetting ? autoScheduleSetting.value === 'true' : false;
const showSuccess = req.query.success === 'updated';

let content = `
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
          <li class="breadcrumb-item active">Follow-up Settings</li>
        </ol>
      </nav>
      <h1><i class="bi bi-envelope-arrow-up"></i> Follow-up Email Settings</h1>
      <p class="text-muted">Configure time intervals for automatic follow-up emails</p>
    </div>
  </div>

  ${showSuccess ? `
  <!-- Success Message -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> Follow-up settings updated successfully!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    </div>
  </div>
  ` : ''}

  <!-- Follow-up Schedule -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-primary">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-calendar-range"></i> Follow-up Schedule Configuration
        </div>
        <div class="card-body">
          <p class="text-muted mb-4">Configure how many days after the main email to send each follow-up. Follow-ups will be scheduled automatically when the main email is sent (if enabled).</p>

          <form method="POST" action="/settings/followup">
            <div class="row g-4">
              <!-- Follow-up 1 -->
              <div class="col-md-3">
                <div class="card">
                  <div class="card-body text-center">
                    <div class="mb-3">
                      <span class="badge bg-primary fs-6">Follow-up #1</span>
                    </div>
                    <label class="form-label fw-bold">Days After Main Email</label>
                    <input type="number" name="followup_1_interval_days" class="form-control form-control-lg text-center"
                           value="${schedule.followup_1}" min="1" max="365" required>
                    <small class="text-muted">Default: 3 days</small>
                  </div>
                </div>
              </div>

              <!-- Follow-up 2 -->
              <div class="col-md-3">
                <div class="card">
                  <div class="card-body text-center">
                    <div class="mb-3">
                      <span class="badge bg-primary fs-6">Follow-up #2</span>
                    </div>
                    <label class="form-label fw-bold">Days After Main Email</label>
                    <input type="number" name="followup_2_interval_days" class="form-control form-control-lg text-center"
                           value="${schedule.followup_2}" min="1" max="365" required>
                    <small class="text-muted">Default: 7 days</small>
                  </div>
                </div>
              </div>

              <!-- Follow-up 3 -->
              <div class="col-md-3">
                <div class="card">
                  <div class="card-body text-center">
                    <div class="mb-3">
                      <span class="badge bg-primary fs-6">Follow-up #3</span>
                    </div>
                    <label class="form-label fw-bold">Days After Main Email</label>
                    <input type="number" name="followup_3_interval_days" class="form-control form-control-lg text-center"
                           value="${schedule.followup_3}" min="1" max="365" required>
                    <small class="text-muted">Default: 14 days</small>
                  </div>
                </div>
              </div>

              <!-- Follow-up 4 -->
              <div class="col-md-3">
                <div class="card">
                  <div class="card-body text-center">
                    <div class="mb-3">
                      <span class="badge bg-primary fs-6">Follow-up #4</span>
                    </div>
                    <label class="form-label fw-bold">Days After Main Email</label>
                    <input type="number" name="followup_4_interval_days" class="form-control form-control-lg text-center"
                           value="${schedule.followup_4}" min="1" max="365" required>
                    <small class="text-muted">Default: 21 days</small>
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-4">

            <!-- Auto-Schedule Toggle -->
            <div class="row align-items-center mb-4">
              <div class="col-9">
                <label class="form-label fw-bold">Auto-Schedule Follow-ups</label>
                <p class="text-muted mb-0">When enabled, follow-up emails will be automatically scheduled after the main email is sent. When disabled, you must manually trigger follow-ups.</p>
              </div>
              <div class="col-3 text-end">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" name="auto_schedule_followups" id="autoScheduleSwitch"
                         value="true" ${autoSchedule ? 'checked' : ''}>
                  <label class="form-check-label" for="autoScheduleSwitch">
                    ${autoSchedule ? 'Enabled' : 'Disabled'}
                  </label>
                </div>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-save"></i> Save Settings
              </button>
              <a href="/settings/daily-limits" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Settings
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Current Configuration Display -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-light">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-info-circle"></i> Current Schedule</h5>
          <div class="row text-center">
            <div class="col-md-3">
              <div class="p-3">
                <div class="display-6 mb-2">${schedule.followup_1}</div>
                <div class="text-muted">Day #1</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="p-3">
                <div class="display-6 mb-2">${schedule.followup_2}</div>
                <div class="text-muted">Day #2</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="p-3">
                <div class="display-6 mb-2">${schedule.followup_3}</div>
                <div class="text-muted">Day #3</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="p-3">
                <div class="display-6 mb-2">${schedule.followup_4}</div>
                <div class="text-muted">Day #4</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Cards -->
  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <i class="bi bi-lightbulb"></i> How It Works
        </div>
        <div class="card-body">
          <ol class="mb-0">
            <li class="mb-2">When a main outreach email is sent, the system can automatically schedule follow-up emails</li>
            <li class="mb-2">Each follow-up is queued based on the configured day intervals</li>
            <li class="mb-2">The email queue processes emails on their scheduled dates</li>
            <li>You can disable auto-scheduling and manually trigger follow-ups per lead</li>
          </ol>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <i class="bi bi-exclamation-triangle"></i> Important Notes
        </div>
        <div class="card-body">
          <ul class="mb-0">
            <li class="mb-2">Follow-ups will only be sent if the lead hasn't replied</li>
            <li class="mb-2">Daily email limits still apply to follow-up emails</li>
            <li class="mb-2">You can cancel scheduled follow-ups from the email queue</li>
            <li>Templates can be customized in the Email Templates section</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Update toggle label on change
document.getElementById('autoScheduleSwitch').addEventListener('change', function() {
  const label = this.nextElementSibling;
  label.textContent = this.checked ? 'Enabled' : 'Disabled';
});
</script>
`;
%>
<%- include('../layout', { title: 'Follow-up Settings - Settings', activePage: 'settings', content: content, user: user }) %>
