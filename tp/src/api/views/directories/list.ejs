<%
let content = `
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item active">Directories</li>
        </ol>
      </nav>
      <h1><i class="bi bi-folder"></i> Directories</h1>
      <p class="text-muted">Manage directory sources for scraping (Clutch, GoodFirms, etc.)</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h5 class="card-title">Total Directories</h5>
          <p class="card-text display-6">${stats.total}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h5 class="card-title">Active</h5>
          <p class="card-text display-6">${stats.active}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-secondary">
        <div class="card-body">
          <h5 class="card-title">Inactive</h5>
          <p class="card-text display-6">${stats.inactive}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-info">
        <div class="card-body">
          <h5 class="card-title">Platforms</h5>
          <p class="card-text display-6">${stats.byPlatform.length}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters & Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleFilters()">
          <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h6>
          <i class="bi bi-chevron-down" id="filterToggleIcon"></i>
        </div>
        <div class="card-body" id="filtersBody">
          <form method="GET" action="/directories">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label small fw-semibold"><i class="bi bi-diagram-3 me-1"></i>Platform</label>
                <select name="platform" class="form-select form-select-sm">
                  <option value="">All Platforms</option>
${platforms.map(p => `
                  <option value="${p}" ${filters.platform === p ? 'selected' : ''}>${p.charAt(0).toUpperCase() + p.slice(1)}</option>`).join('')}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small fw-semibold"><i class="bi bi-geo-alt me-1"></i>Country</label>
                <select name="country" class="form-select form-select-sm">
                  <option value="">All Countries</option>
${countries.map(c => `
                  <option value="${c}" ${filters.country === c ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small fw-semibold"><i class="bi bi-toggle-on me-1"></i>Status</label>
                <select name="is_active" class="form-select form-select-sm">
                  <option value="">All Statuses</option>
                  <option value="true" ${filters.is_active === true ? 'selected' : ''}>Active Only</option>
                  <option value="false" ${filters.is_active === false ? 'selected' : ''}>Inactive Only</option>
                </select>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12 d-flex flex-wrap gap-2">
                <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-check-circle"></i> Apply Filters</button>
                <a href="/directories" class="btn btn-outline-secondary btn-sm"><i class="bi bi-x-circle"></i> Clear All</a>
                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addDirectoryModal"><i class="bi bi-plus-circle"></i> Add Directory</button>
                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importCsvModal"><i class="bi bi-file-earmark-spreadsheet"></i> Import CSV</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Directories Table -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="directoriesTable">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAll" class="form-check-input"></th>
                  <th>Name</th>
                  <th>Platform</th>
                  <th>Country</th>
                  <th>Location</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Last Scraped</th>
                  <th>Stats</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
${directories.map(dir => {
                let platformBadge = 'secondary';
                if (dir.platform === 'clutch') platformBadge = 'primary';
                else if (dir.platform === 'goodfirms') platformBadge = 'success';

                const statusBadge = dir.is_active ? 'success' : 'secondary';
                const statusText = dir.is_active ? 'Active' : 'Inactive';

                return `
                <tr data-id="${dir.id}">
                  <td><input type="checkbox" class="form-check-input directory-checkbox" value="${dir.id}"></td>
                  <td>
                    <strong>${dir.name}</strong><br>
                    <small class="text-muted"><a href="${dir.url}" target="_blank">${dir.url.substring(0, 50)}${dir.url.length > 50 ? '...' : ''}</a></small>
                  </td>
                  <td><span class="badge bg-${platformBadge}">${dir.platform.charAt(0).toUpperCase() + dir.platform.slice(1)}</span></td>
                  <td>${dir.country || '-'}</td>
                  <td>${dir.city || '-'}</td>
                  <td>${dir.category || '-'}</td>
                  <td><span class="badge bg-${statusBadge}">${statusText}</span></td>
                  <td>${dir.last_scraped_at ? new Date(dir.last_scraped_at).toLocaleDateString() : 'Never'}</td>
                  <td>
                    <small>Scraped: ${dir.scrape_count || 0}<br>Found: ${dir.companies_found || 0}</small>
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-sm btn-outline-primary toggle-status" data-id="${dir.id}" title="Toggle Status">
                        <i class="bi bi-toggle-${dir.is_active ? 'on' : 'off'}"></i>
                      </button>
                      <a href="/directories/${dir.id}/edit" class="btn btn-sm btn-outline-secondary" title="Edit">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <form method="POST" action="/directories/${dir.id}/delete"
                        onsubmit="return confirm('Delete this directory?');"
                        style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>`;
              }).join('')}

${directories.length === 0 ? `
                <tr>
                  <td colspan="10" class="text-center text-muted py-4">No directories found.</td>
                </tr>` : ''}
              </tbody>
            </table>
          </div>

${directories.length > 0 ? `
          <div class="mt-3">
            <button class="btn btn-sm btn-outline-success" id="bulkToggleActive">Toggle Active</button>
            <button class="btn btn-sm btn-outline-danger" id="bulkDelete">Delete Selected</button>
          </div>
        ` : ''}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Directory Modal -->
<div class="modal fade" id="addDirectoryModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Directory</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="/directories">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name *</label>
              <input type="text" name="name" class="form-control" placeholder="e.g., Clutch - Bangalore" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Platform *</label>
              <select name="platform" class="form-select" required>
                <option value="">Select Platform</option>
                <option value="clutch">Clutch</option>
                <option value="goodfirms">GoodFirms</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">URL *</label>
              <input type="url" name="url" class="form-control" placeholder="https://clutch.co/in/developers/bangalore" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Country</label>
              <input type="text" name="country" class="form-control" placeholder="e.g., India">
            </div>
            <div class="col-md-4">
              <label class="form-label">Location</label>
              <input type="text" name="city" class="form-control" placeholder="e.g., Bangalore">
            </div>
            <div class="col-md-4">
              <label class="form-label">Category</label>
              <input type="text" name="category" class="form-control" placeholder="e.g., software">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Directory</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importCsvModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="/directories/import-csv">
        <div class="modal-header">
          <h5 class="modal-title">Import Directories from CSV</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">CSV File URL *</label>
            <input type="url" name="csv_url" class="form-control"
              placeholder="https://docs.google.com/spreadsheets/d/..."
              required>
            <div class="form-text">
              Paste the URL of a published CSV or Google Sheet. For Google Sheets, use File > Share > Publish to web.
            </div>
          </div>
          <div class="alert alert-info">
            <small><strong>CSV Format:</strong> The CSV should have columns: Name, URL, Platform, Category, Country, Location<br>
            <strong>Platforms:</strong> clutch, goodfirms, or other</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Import</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Toggle status via AJAX
document.querySelectorAll('.toggle-status').forEach(btn => {
  btn.addEventListener('click', async function() {
    const id = this.dataset.id;
    try {
      const res = await fetch(\`/directories/\${id}/toggle\`, { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        location.reload();
      }
    } catch (err) {
      alert('Failed to toggle status');
    }
  });
});

// Select all checkbox
document.getElementById('selectAll')?.addEventListener('change', function() {
  document.querySelectorAll('.directory-checkbox').forEach(cb => {
    cb.checked = this.checked;
  });
});

// Bulk toggle active
document.getElementById('bulkToggleActive')?.addEventListener('click', async function() {
  const selected = Array.from(document.querySelectorAll('.directory-checkbox:checked')).map(cb => cb.value);
  if (selected.length === 0) return alert('No directories selected');

  const active = confirm('Make active? Click Cancel for inactive');
  try {
    const res = await fetch('/directories/bulk-toggle', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ directory_ids: selected, is_active: active })
    });
    const data = await res.json();
    if (data.success) {
      location.reload();
    }
  } catch (err) {
    alert('Failed to update directories');
  }
});

// Bulk delete
document.getElementById('bulkDelete')?.addEventListener('click', async function() {
  const selected = Array.from(document.querySelectorAll('.directory-checkbox:checked')).map(cb => cb.value);
  if (selected.length === 0) return alert('No directories selected');
  if (!confirm(\`Delete \${selected.length} directories?\`)) return;

  try {
    const res = await fetch('/directories/bulk-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ directory_ids: selected })
    });
    const data = await res.json();
    if (data.success) {
      location.reload();
    }
  } catch (err) {
    alert('Failed to delete directories');
  }
});

function toggleFilters() {
  const body = document.getElementById('filtersBody');
  const icon = document.getElementById('filterToggleIcon');
  if (body.style.display === 'none') {
    body.style.display = 'block';
    icon.classList.remove('bi-chevron-down');
    icon.classList.add('bi-chevron-up');
  } else {
    body.style.display = 'none';
    icon.classList.remove('bi-chevron-up');
    icon.classList.add('bi-chevron-down');
  }
}
</script>
`;
%>
<%- include('../layout', { title: 'Directories', activePage: 'directories', content: content, user: user }) %>
