<% let content = `
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <div>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/prospects">Prospects</a></li>
            <li class="breadcrumb-item active">${prospect.domain}</li>
          </ol>
        </nav>
        <h1>
          <i class="bi bi-building"></i> ${prospect.company_name ||
          prospect.domain}
        </h1>
        <p class="text-muted mb-0">
          <a href="https://${prospect.domain}" target="_blank"
            >${prospect.domain}</a
          >
          ${prospect.city ? ` |
          <i class="bi bi-geo-alt"></i> ${prospect.city}${prospect.country ? `,
          ${prospect.country}` : ''}` : ''}
        </p>
      </div>
      <div>
        <div class="btn-group">
          <a
            href="/emails/new?prospect_id=${prospect.id}"
            class="btn btn-primary"
          >
            <i class="bi bi-plus-lg"></i> Add Email
          </a>
          <a
            href="/prospects/${prospect.id}/edit"
            class="btn btn-outline-secondary"
          >
            <i class="bi bi-pencil"></i> Edit
          </a>
          <form
            method="POST"
            action="/prospects/${prospect.id}/delete"
            class="d-inline"
          >
            <button
              type="submit"
              class="btn btn-outline-danger"
              onclick="return confirm('Are you sure you want to delete this prospect? This will also delete all associated emails and leads.');"
            >
              <i class="bi bi-trash"></i> Delete
            </button>
          </form>
          <form
            method="POST"
            action="/prospects/${prospect.id}/exclude"
            class="d-inline"
          >
            <input type="hidden" name="reason" value="Manual exclusion" />
            <button
              type="submit"
              class="btn btn-outline-danger"
              onclick="return confirm('Add to exclusion list?');"
            >
              <i class="bi bi-ban"></i> Exclude
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Cards -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <i class="bi bi-info-circle"></i> Prospect Information
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <th>Domain:</th>
              <td>${prospect.domain}</td>
            </tr>
            <tr>
              <th>Company Name:</th>
              <td>${prospect.company_name || '-'}</td>
            </tr>
            <tr>
              <th>City:</th>
              <td>${prospect.city || '-'}</td>
            </tr>
            <tr>
              <th>Country:</th>
              <td>${prospect.country || '-'}</td>
            </tr>
            <tr>
              <th>Source Type:</th>
              <td>
                <span class="badge bg-info"
                  >${prospect.last_source_type || 'unknown'}</span
                >
              </td>
            </tr>
            <tr>
              <th>Emails Extracted:</th>
              <td>
                <span
                  class="badge bg-${prospect.emails_extracted ? 'success' : 'secondary'}"
                  >${prospect.emails_extracted ? 'Yes' : 'No'}</span
                >
              </td>
            </tr>
            <tr>
              <th>Created:</th>
              <td>${new Date(prospect.created_at).toLocaleString()}</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <i class="bi bi-envelope"></i> Emails (${emails.length})
        </div>
        <div class="card-body">
          ${emails.length > 0 ? `
          <div class="list-group">
            ${emails.map(email => `
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <a href="/emails/${email.id}">${email.email}</a>
                  <div class="small text-muted">
                    ${email.is_domain_match ? `<span class="badge bg-success"
                      >Domain Match</span
                    >` : ''} ${email.is_generic ? `<span
                      class="badge bg-warning text-dark"
                      >Generic</span
                    >` : ''} Confidence: ${email.confidence}%
                  </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                  <small
                    >${new Date(email.created_at).toLocaleDateString()}</small
                  >
                  <div class="btn-group btn-group-sm">
                    <button
                      class="btn btn-outline-primary btn-sm"
                      onclick="showQueueModal('${email.id}')"
                      title="Add to Queue"
                    >
                      <i class="bi bi-envelope-plus"></i> Queue
                    </button>
                    <a
                      href="/emails/${email.id}/edit"
                      class="btn btn-outline-secondary btn-sm"
                    >
                      <i class="bi bi-pencil"></i>
                    </a>
                    <form
                      method="POST"
                      action="/emails/${email.id}/delete"
                      class="d-inline"
                    >
                      <button
                        type="submit"
                        class="btn btn-outline-danger btn-sm"
                        onclick="return confirm('Delete this email?');"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            `).join('')}
          </div>
          ` : `
          <p class="text-muted mb-0">No emails found for this prospect.</p>
          `}
        </div>
      </div>
    </div>
  </div>

  <!-- Campaign Associations -->
  ${leads.length > 0 ? `
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <i class="bi bi-link-45deg"></i> Campaign Associations
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Brand</th>
                  <th>Campaign</th>
                  <th>Status</th>
                  <th>Source</th>
                  <th>Found At</th>
                </tr>
              </thead>
              <tbody>
                ${leads.map(lead => { let statusColor = 'secondary';
                switch(lead.status) { case 'NEW': statusColor = 'secondary';
                break; case 'READY': statusColor = 'info'; break; case
                'OUTREACH_SENT': statusColor = 'primary'; break; case 'REPLIED':
                statusColor = 'success'; break; case 'REJECTED': statusColor =
                'danger'; break; } return `
                <tr>
                  <td>${lead.brand_name}</td>
                  <td>
                    <a href="/campaigns/${lead.campaign_id}"
                      >${lead.campaign_name}</a
                    >
                  </td>
                  <td>
                    <span class="badge bg-${statusColor}">${lead.status}</span>
                  </td>
                  <td>
                    <span class="badge bg-info">${lead.source_type}</span>
                  </td>
                  <td>${new Date(lead.found_at).toLocaleDateString()}</td>
                </tr>
                `;}).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  ` : ''}
</div>

<!-- Queue Email Modal -->
<div class="modal fade" id="queueEmailModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Queue Email</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="queueForm">
          <input type="hidden" name="email_id" id="queueEmailId" />

          <div class="mb-3">
            <label class="form-label">Select Campaign (Lead)</label>
            <select name="lead_id" class="form-select" required>
              <option value="">Choose a campaign...</option>
              ${leads.map(l => `
              <option value="${l.id}">
                ${l.campaign_name} (${l.brand_name})
              </option>
              `).join('')}
            </select>
            <div class="form-text">
              Select which campaign this email is for.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Select Template</label>
            <select name="template_id" class="form-select" required>
              <option value="">Choose a template...</option>
              ${templates.map(t => `
              <option value="${t.id}">${t.name}</option>
              `).join('')}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="submitQueue()">
          Add to Queue
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function showQueueModal(emailId) {
    document.getElementById("queueEmailId").value = emailId;
    const modal = new bootstrap.Modal(
      document.getElementById("queueEmailModal")
    );
    modal.show();
  }

  function submitQueue() {
    const emailId = document.getElementById("queueEmailId").value;
    const leadId = document.querySelector(
      '#queueForm select[name="lead_id"]'
    ).value;
    const templateId = document.querySelector(
      '#queueForm select[name="template_id"]'
    ).value;

    if (!leadId || !templateId) {
      alert("Please select both a campaign and a template");
      return;
    }

    const btn = document.querySelector("#queueEmailModal .btn-primary");
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "Processing...";

    fetch("/email-outreach/queue/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        lead_ids: [leadId],
        email_ids: [emailId],
        template_id: templateId,
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          if (data.failed > 0) {
            alert(
              "Failed to queue email: " +
                (data.errors[0]?.error || "Unknown error")
            );
          } else {
            alert("Email added to queue successfully!");
            location.reload();
          }
        } else {
          alert("Error: " + data.error);
        }
      })
      .catch((err) => alert("Error: " + err.message))
      .finally(() => {
        btn.disabled = false;
        btn.textContent = originalText;
      });
  }
</script>
`; %> <%- include('../layout', { title: prospect.domain + ' - Outreach Admin',
activePage: 'prospects', content: content, user: user }) %>
