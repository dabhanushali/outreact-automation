<%
let content = `
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <div>
        <h1><i class="bi bi-list-ul"></i> Email Queue</h1>
        <p class="text-muted">View and manage queued emails</p>
      </div>
      ${stats.pending > 0 ? `
        <button type="button" class="btn btn-outline-danger" onclick="confirmClearQueue()">
          <i class="bi bi-x-circle"></i> Clear Queue (${stats.pending})
        </button>
      ` : ''}
    </div>
  </div>

  <!-- Queue Stats -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-warning">
        <div class="card-body text-center">
          <h3 class="text-warning">${stats.pending}</h3>
          <small class="text-muted">Pending</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-info">
        <div class="card-body text-center">
          <h3 class="text-info">${stats.sending}</h3>
          <small class="text-muted">Sending</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-success">
        <div class="card-body text-center">
          <h3 class="text-success">${stats.sentToday}</h3>
          <small class="text-muted">Sent Today</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-danger">
        <div class="card-body text-center">
          <h3 class="text-danger">${stats.failed}</h3>
          <small class="text-muted">Failed Today</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Queue Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">
          <i class="bi bi-gear"></i> Queue Actions
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>How to send emails:</strong> Run <code>node run-email-sender.js</code> in your terminal.
            This will process pending emails with rate limiting (30-60s delays between sends).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="row mb-3">
    <div class="col-12">
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link ${!filters.status ? 'active' : ''}" href="/email-outreach/queue">All</a>
        </li>
        <li class="nav-item">
          <a class="nav-link ${filters.status === 'pending' ? 'active' : ''}" href="/email-outreach/queue?status=pending">
            Pending (${stats.pending})
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link ${filters.status === 'sent' ? 'active' : ''}" href="/email-outreach/queue?status=sent">
            Sent
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link ${filters.status === 'failed' ? 'active' : ''}" href="/email-outreach/queue?status=failed">
            Failed
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Queue Table -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          ${queuedEmails.length === 0 ? `
            <div class="text-center text-muted py-5">
              <i class="bi bi-inbox" style="font-size: 3rem;"></i>
              <p class="mt-3">No emails in queue ${filters.status ? 'with status: ' + filters.status : ''}</p>
              <a href="/leads" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Add Leads to Queue
              </a>
            </div>
          ` : `
            <div class="table-responsive">
              <table class="table table-hover table-sm">
                <thead>
                  <tr>
                    <th>To</th>
                    <th>Company</th>
                    <th>Subject</th>
                    <th>Campaign</th>
                    <th>Status</th>
                    <th>Scheduled</th>
                    <th>Sent</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${queuedEmails.map(email => `
                    <tr>
                      <td>${email.to_email}</td>
                      <td>${email.company_name || email.domain}</td>
                      <td><small>${email.subject.substring(0, 50)}${email.subject.length > 50 ? '...' : ''}</small></td>
                      <td><span class="badge bg-secondary">${email.campaign_name}</span></td>
                      <td>
                        <span class="badge bg-${
                          email.status === 'sent' ? 'success' :
                          email.status === 'failed' ? 'danger' :
                          email.status === 'sending' ? 'info' : 'warning'
                        }">
                          ${email.status}
                        </span>
                        ${email.attempts > 0 ? `<small class="text-muted">(${email.attempts} attempts)</small>` : ''}
                      </td>
                      <td><small>${new Date(email.scheduled_for).toLocaleString()}</small></td>
                      <td>${email.sent_at ? `<small>${new Date(email.sent_at).toLocaleString()}</small>` : '-'}</td>
                      <td>
                        ${email.status === 'pending' ? `
                          <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteQueueItem(${email.id})">
                            <i class="bi bi-trash"></i>
                          </button>
                        ` : ''}
                        ${email.error_message ? `<i class="bi bi-exclamation-triangle text-danger" title="${email.error_message}"></i>` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function confirmClearQueue() {
  if (confirm('Are you sure you want to clear all pending emails from the queue?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/email-outreach/queue/clear';
    document.body.appendChild(form);
    form.submit();
  }
}

function deleteQueueItem(id) {
  if (confirm('Remove this email from the queue?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/email-outreach/queue/' + id + '/delete';
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
`;
%>
<%- include('../layout', { title: 'Email Queue - Outreach Admin', activePage: 'email-outreach', content: content, user: user }) %>
