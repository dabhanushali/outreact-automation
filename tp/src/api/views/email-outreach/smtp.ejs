<%
let content = `
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h1><i class="bi bi-gear"></i> SMTP Configuration</h1>
      <p class="text-muted">Configure your email server settings</p>
    </div>
  </div>

  <!-- Connection Status -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card ${config ? 'border-success' : 'border-secondary'}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">SMTP Configuration Status</h6>
              <p class="mb-0">
                ${config ? `
                  <span class="badge bg-success">Configured</span>
                  <span class="text-muted ms-2">${config.host}:${config.port}</span>
                ` : `
                  <span class="badge bg-secondary">Not Configured</span>
                  <span class="text-muted ms-2">Please configure your SMTP settings below</span>
                `}
              </p>
            </div>
            ${config ? `
              <button type="button" class="btn btn-outline-primary" onclick="testConnection()">
                <i class="bi bi-wifi"></i> Test Connection
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SMTP Configuration Form -->
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <i class="bi bi-sliders"></i> SMTP Settings
        </div>
        <div class="card-body">
          <form method="POST" action="/email-outreach/smtp/config">
            <div class="row mb-3">
              <div class="col-md-8">
                <label for="host" class="form-label">SMTP Host</label>
                <input type="text" class="form-control" id="host" name="host" required
                  value="${config ? config.host : ''}"
                  placeholder="e.g., smtp.gmail.com">
              </div>
              <div class="col-md-4">
                <label for="port" class="form-label">Port</label>
                <input type="number" class="form-control" id="port" name="port" required
                  value="${config ? config.port : '587'}"
                  placeholder="587">
              </div>
            </div>

            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="secure" name="secure" value="1"
                  ${config && config.secure ? 'checked' : ''}>
                <label class="form-check-label" for="secure">
                  Use SSL/TLS (secure connection)
                </label>
                <small class="form-text text-muted d-block">
                  Enable for port 465 (SSL) or 587 (STARTTLS). Disable for port 25.
                </small>
              </div>
            </div>

            <div class="mb-3">
              <label for="user" class="form-label">Username (optional)</label>
              <input type="text" class="form-control" id="user" name="user"
                value="${config ? config.user || '' : ''}"
                placeholder="e.g., user@example.com">
              <small class="form-text text-muted">
                Leave blank if your SMTP doesn't require authentication
              </small>
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Password (optional)</label>
              <input type="password" class="form-control" id="password" name="password"
                placeholder="Enter SMTP password">
              ${config && config.password ? `
                <small class="form-text text-muted">
                  <i class="bi bi-shield-check"></i> Password is stored. Leave blank to keep existing.
                </small>
              ` : ''}
            </div>

            <hr>

            <div class="mb-3">
              <label for="from_email" class="form-label">From Email</label>
              <input type="email" class="form-control" id="from_email" name="from_email" required
                value="${config ? config.from_email : ''}"
                placeholder="e.g., outreach@yourcompany.com">
            </div>

            <div class="mb-3">
              <label for="from_name" class="form-label">From Name (optional)</label>
              <input type="text" class="form-control" id="from_name" name="from_name"
                value="${config ? config.from_name || '' : ''}"
                placeholder="e.g., Your Company Outreach">
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Save Configuration
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-info">
        <div class="card-header bg-info text-white">
          <i class="bi bi-info-circle"></i> Common SMTP Providers
        </div>
        <div class="card-body">
          <h6>Gmail</h6>
          <ul class="small mb-3">
            <li>Host: smtp.gmail.com</li>
            <li>Port: 587</li>
            <li>Secure: Yes</li>
          </ul>

          <h6>Outlook/Office 365</h6>
          <ul class="small mb-3">
            <li>Host: smtp.office365.com</li>
            <li>Port: 587</li>
            <li>Secure: Yes</li>
          </ul>

          <h6>SendGrid</h6>
          <ul class="small mb-3">
            <li>Host: smtp.sendgrid.net</li>
            <li>Port: 587</li>
            <li>Secure: Yes</li>
          </ul>

          <h6>Mailgun</h6>
          <ul class="small">
            <li>Host: smtp.mailgun.org</li>
            <li>Port: 587</li>
            <li>Secure: Yes</li>
          </ul>
        </div>
      </div>

      <div class="card border-warning mt-3">
        <div class="card-header bg-warning text-dark">
          <i class="bi bi-exclamation-triangle"></i> Important Notes
        </div>
        <div class="card-body">
          <ul class="small mb-0">
            <li>Use an App Password if you have 2FA enabled</li>
            <li>Check "Less Secure Apps" for Gmail (deprecated, use App Password)</li>
            <li>Send test emails after configuration</li>
            <li>Daily limits apply to avoid spam filtering</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
async function testConnection() {
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';

  try {
    const response = await fetch('/email-outreach/smtp/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    const result = await response.json();

    if (result.success) {
      alert('✅ Connection successful! Your SMTP is configured correctly.');
    } else {
      alert('❌ Connection failed: ' + result.message);
    }
  } catch (error) {
    alert('❌ Error testing connection: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}
</script>
`;
%>
<%- include('../layout', { title: 'SMTP Configuration - Outreach Admin', activePage: 'email-outreach', content: content, user: user }) %>
