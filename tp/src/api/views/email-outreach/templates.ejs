<%
let content = `
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <div>
        <h1><i class="bi bi-file-earmark-text"></i> Email Templates</h1>
        <p class="text-muted">Create and manage email templates with variable substitution</p>
      </div>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
        <i class="bi bi-plus-lg"></i> New Template
      </button>
    </div>
  </div>

  <!-- Variable Reference -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-info">
        <div class="card-header bg-info text-white">
          <i class="bi bi-info-circle"></i> Available Variables
        </div>
        <div class="card-body">
          <p class="mb-2">Use these variables in your templates. They will be replaced with actual data when sending:</p>
          <div class="row">
            ${availableVariables.map(v => `
              <div class="col-md-3 mb-2">
                <code class="text-primary">{{${v.name}}}</code>
                <small class="text-muted d-block">${v.description}</small>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates List -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          ${templates.length === 0 ? `
            <div class="text-center text-muted py-5">
              <i class="bi bi-file-earmark-text" style="font-size: 3rem;"></i>
              <p class="mt-3">No email templates yet.</p>
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
                <i class="bi bi-plus-lg"></i> Create Your First Template
              </button>
            </div>
          ` : `
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Subject</th>
                    <th>Variables</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${templates.map(t => {
                    let vars = [];
                    try {
                      vars = t.variables ? JSON.parse(t.variables) : [];
                    } catch (e) {
                      vars = [];
                    }
                    return `
                    <tr>
                      <td><strong>${t.name}</strong></td>
                      <td>${t.subject}</td>
                      <td>${vars.length > 0 ? vars.map(v => `<code>${v}</code>`).join(' ') : '<span class="text-muted">None</span>'}</td>
                      <td>
                        <span class="badge bg-${t.is_active ? 'success' : 'secondary'}">
                          ${t.is_active ? 'Active' : 'Inactive'}
                        </span>
                      </td>
                      <td>${new Date(t.created_at).toLocaleDateString()}</td>
                      <td>
                        <a href="/email-outreach/templates/${t.id}" class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-pencil"></i> Edit
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${t.id}, '${t.name.replace(/'/g, "\\'")}')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  `}).join('')}
                </tbody>
              </table>
            </div>
          `}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Template Modal -->
<div class="modal fade" id="createTemplateModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Template</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="/email-outreach/templates">
        <div class="modal-body">
          <div class="mb-3">
            <label for="name" class="form-label">Template Name</label>
            <input type="text" class="form-control" id="name" name="name" required placeholder="e.g., Initial Outreach">
          </div>
          <div class="mb-3">
            <label for="subject" class="form-label">Subject Line</label>
            <input type="text" class="form-control" id="subject" name="subject" required placeholder="e.g., Partnership inquiry from {{brand}}">
          </div>
          <div class="mb-3">
            <label for="body" class="form-label">Email Body (HTML)</label>
            <textarea class="form-control" id="body" name="body" rows="10" required placeholder="Hi {{name}},&#10;&#10;I hope this email finds you well. I'm reaching out from {{brand}}..."></textarea>
            <small class="form-text text-muted">
              You can use HTML tags. Variables will be replaced when sending.
            </small>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="is_active" name="is_active" value="1" checked>
              <label class="form-check-label" for="is_active">
                Active (available for campaigns)
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Template</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function confirmDelete(id, name) {
  if (confirm(\`Are you sure you want to delete the template "\${name}"?\`)) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = \`/email-outreach/templates/\${id}/delete\`;
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
`;
%>
<%- include('../layout', { title: 'Email Templates - Outreach Admin', activePage: 'email-outreach', content: content, user: user }) %>
